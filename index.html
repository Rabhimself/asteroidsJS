<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
</head>

<body>

    <canvas id="theCanvas"></canvas>
    <script src="jquery.js"></script>
    <script type="text/javascript">
        var canvas = document.getElementById("theCanvas");
        var ctx = canvas.getContext("2d");
        var roidCount = 0;
        var bodies = []; //array of all objects
        //   w      a      s      d
        var presses = [false, false, false, false, false] //booleans determine if a button is held down.
        var playerShip;
        init();
        step();

        function init() {
            canvas.height = 600;
            canvas.width = 800;
            playerShip = new Ship();
            bodies.push(playerShip);
            for (var i = 0; i < 5; i++) {
                newRoid = new Roid();
                bodies.push(newRoid);
                roidCount++;
            }

        }

        function Ship() { //creates a ship
            this.pos = {
                x: 50,
                y: 50
            };
            this.velocity = {
                x: 0,
                y: 0
            };
            this.acceleration = {
                x: 0,
                y: 0
            };
            this.force = {
                x: 0,
                y: 0
            };
            this.shotCount = 0;
            this.reloading = false;
            this.facing = 0;
            this.thrust = 0;
            this.mass = 20;
            this.topSpeed = 3;
            this.radius = 5;
            this.draw = function () {
                ctx.save();
                ctx.strokeStyle = "black";
                ctx.translate(this.pos.x, this.pos.y);
                ctx.rotate(this.facing * Math.PI / 180);
                ctx.beginPath();
                ctx.moveTo(10, 0);
                ctx.lineTo(-10, 10);
                ctx.lineTo(-5, 0);
                ctx.lineTo(-10, -10);
                ctx.lineTo(10, 0);
                ctx.stroke();
                ctx.closePath();
                ctx.restore();
            }; //xcos ysin
            this.move = function () {
                this.force.x = (this.thrust * Math.cos(this.facing * Math.PI / 180));
                this.force.y = (this.thrust * Math.sin(this.facing * Math.PI / 180));
                this.velocity.x += this.force.x / this.mass;
                this.velocity.y += this.force.y / this.mass;
                if(Math.abs(this.velocity.x > 10))
                    this.velocity.x = 10
                this.pos.x += this.velocity.x;
                if(Math.abs(this.velocity.y > 10))
                    this.velocity.y = 10
                this.pos.y += this.velocity.y;
            }
            this.shoot = function () {
                this.reloading = true;
                var shotID = this.shotCount++;
                var projectile = new Projectile(this.pos.x, this.pos.y, this.facing, shotID); //get ship velocity vector and + radius to determine spawn point
                bodies.push(projectile);
                setTimeout(function () {
                    playerShip.reloading = false
                }, 250);
                setTimeout(function () { //anon function to delete the projectile after 2 seconds
                    for (var i in bodies)
                        if (bodies[i].id == shotID)
                            bodies.splice(i, 1);
                }, 2000);


            }
        }

        function Projectile(xloc, yloc, heading, shotCount) {
            console.log(xloc + " " + yloc);
            this.pos = {
                x: xloc,
                y: yloc
            };
            this.id = shotCount;
            this.velocity = 6;
            this.acceleration = 0;
            this.facing = heading;
            this.topSpeed = 5;
            this.radius = 10;
            this.draw = function () {
                    ctx.save();
                    ctx.strokeStyle = "black";
                    ctx.translate(this.pos.x, this.pos.y);
                    ctx.rotate(this.facing * Math.PI / 180);
                    ctx.beginPath();
                    ctx.moveTo(10, 0);
                    ctx.lineTo(7, -2);
                    ctx.lineTo(0, -2);
                    ctx.lineTo(0, 2);
                    ctx.lineTo(7, 2);
                    ctx.lineTo(10, 0);
                    ctx.stroke();
                    ctx.closePath();
                    ctx.restore();
                } //xcos ysin
            this.move = function () {
                if (this.velocity < this.topSpeed)
                    this.velocity += this.acceleration;
                this.pos.x += (this.velocity * Math.cos(this.facing * Math.PI / 180));
                this.pos.y += (this.velocity * Math.sin(this.facing * Math.PI / 180));
            }
        }

        function Roid() { //creates a small asteroid

            this.pos = {
                x: Math.random() * 800,
                y: Math.random() * 600
            };
            this.velocity = Math.random();
            this.acceleration = 0;
            this.facing = Math.random() * 360;
            this.direction = Math.random() * 360;
            this.topSpeed = 5;
            this.radius = 10;
            this.draw = function () {
                    ctx.save();
                    ctx.strokeStyle = "black";
                    ctx.translate(this.pos.x, this.pos.y);
                    ctx.rotate(this.facing * Math.PI / 180);
                    ctx.beginPath();
                    ctx.moveTo(10, 0);
                    ctx.lineTo(5, 8);
                    ctx.lineTo(0, 8);
                    ctx.lineTo(-8, 8);
                    ctx.lineTo(-9, 0);
                    ctx.lineTo(-4, -6);
                    ctx.lineTo(-8, -9);
                    ctx.lineTo(-5, -11);
                    ctx.lineTo(3, -10);
                    ctx.lineTo(8, -1);
                    ctx.lineTo(10, 0);
                    ctx.stroke();
                    ctx.closePath();
                    ctx.restore();
                } //xcos ysin
            this.move = function () {
                if (this.velocity < this.topSpeed)
                    this.velocity += this.acceleration;
                this.pos.x += (this.velocity * Math.cos(this.direction * Math.PI / 180));
                this.pos.y += (this.velocity * Math.sin(this.direction * Math.PI / 180));
            }
        }

        $(document).on("keydown", function () {
            if (event.which == 87) { //w
                presses[0] = true;
            }
            if (event.which == 65) { //a
                presses[1] = true;
            }
            if (event.which == 83) { //s
                presses[2] = true;
            }
            if (event.which == 68) { //d
                presses[3] = true;
            }
            if (event.which == 32) { //space
                presses[4] = true;
            }

        });

        $(document).on("keyup", function () {
            if (event.which == 87) { //w
                presses[0] = false;
            }
            if (event.which == 65) { //a
                presses[1] = false;
            }
            if (event.which == 83) { //s
                presses[2] = false;
            }
            if (event.which == 68) { //d
                presses[3] = false;
            }
            if(event.which == 32)
                presses[4] = false;

        });

        function checkPresses() {
            if (presses[0] == true) {
                
                playerShip.thrust = 2;

            } else
                playerShip.thrust = 0;
            if (presses[1] == true) {
                playerShip.facing -= 5;
            }
            if (presses[2] == true) {
                playerShip.thrust = -2;
            }
            if (presses[3] == true) {
                playerShip.facing += 5;
            }
            if(presses[4] == true && playerShip.reloading == false)
                    playerShip.shoot();
        }

        function colCheck() {
            for (var i in bodies) {
                boundaryCheck(bodies[i]);
                for (var j in bodies) {
                    if ((i != j) && ((bodies[i] instanceof Roid) || (bodies[j] instanceof Roid))) {
                        var distX = bodies[i].pos.x - bodies[j].pos.x;
                        var distY = bodies[i].pos.y - bodies[j].pos.y;
                        var dist = (distX * distX) + (distY * distY);
                        var radSqrd = (bodies[i].radius + bodies[j].radius) * (bodies[i].radius + bodies[j].radius);
                        var bool = Boolean(dist < radSqrd);
                        if (bool) {
                            if (i == 0) {
                                window.alert("Game Over!");
                                location.reload();
                            }

                            if (i < j) {
                                bodies.splice(j, 1);
                                bodies.splice(i, 1);
                            } else {
                                bodies.splice(i, 1);
                                bodies.splice(j, 1);
                            }
                        }; //collision 
                    }
                }
            }
        }

        function boundaryCheck(body) {

            if (body.pos.x + body.radius < 0) //make sure the object leaves the LEFT SIDE before moving it
            {
                body.pos.x = canvas.width + body.radius;
            }
            if (body.pos.x - body.radius > canvas.width) //make sure the object leaves the RIGHT SIDE before moving it
            {
                body.pos.x = 0 + body.radius;
            }
            if (body.pos.y + body.radius < 0) //make sure the object leaves the TOP before moving it
            {
                body.pos.y = canvas.height - body.radius;
            }
            if (body.pos.y - body.radius > canvas.height) //make sure the object leaves the TOP before moving it
            {
                body.pos.y = 0 + body.radius;
            }
        }

        function step() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            checkPresses();
            for (var i in bodies) {
                bodies[i].move();
                bodies[i].draw();
            }
            ctx.fillStyle = "black";
            ctx.fillText(playerShip.facing, 0, 0);
            colCheck();
            window.requestAnimationFrame(step);
        }
    </script>
</body>

</html>