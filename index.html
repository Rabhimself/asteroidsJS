<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
</head>

<body>

    <canvas id="theCanvas"></canvas>
    <script src="jquery.js"></script>
    <script type="text/javascript">
        var canvas = document.getElementById("theCanvas");
        var ctx = canvas.getContext("2d");
        var roidCount = 0;
        var rand;
        var playerBodies = []; //array of all player objects
        var asteroids = [];
        //   w      a      s      d
        var presses = [false, false, false, false, false] //booleans determine if a button is held down.
        var playerShip;
        init();
        step();

        function init() {
            canvas.height = 600;
            canvas.width = 800;
            playerShip = new Ship();
            playerBodies.push(playerShip);
            for (var i = 0; i < 20; i++) {
                rand = Math.floor(Math.random() * 3);
                newRoid = new Roid();
                if (rand == 0) {
                    newRoid.radius = 8;
                    newRoid.draw = drawSmallRoid;
                } else if (rand == 1) {
                    newRoid.radius = 18;
                    newRoid.draw = drawMediumRoid;
                } else {
                    newRoid.radius = 28;
                    newRoid.draw = drawLargeRoid;
                }
                asteroids.push(newRoid);
                roidCount++;
            }

        }

        function Ship() { //creates a ship
            this.pos = {
                x: canvas.width / 2,
                y: canvas.height / 2
            };
            this.velocity = {
                x: 0,
                y: 0
            };
            this.acceleration = {
                x: 0,
                y: 0
            };
            this.force = {
                x: 0,
                y: 0
            };
            this.shotCount = 0;
            this.shotCharges = 5;
            this.reloading = false;
            this.facing = 0;
            this.thrust = 0;
            this.mass = 20;
            this.score = 0;
            this.topSpeed = 3;
            this.radius = 5;
            this.draw = function () {
                ctx.save();
                ctx.strokeStyle = "white";
                ctx.translate(this.pos.x, this.pos.y);
                ctx.rotate(this.facing * Math.PI / 180);
                ctx.beginPath();
                ctx.moveTo(10, 0);
                ctx.lineTo(-10, 10);
                ctx.lineTo(-5, 0);
                ctx.lineTo(-10, -10);
                ctx.lineTo(10, 0);
                ctx.stroke();
                ctx.closePath();
                ctx.restore();
            }; //xcos ysin
            this.move = function () {
                this.force.x = (this.thrust * Math.cos(this.facing * Math.PI / 180));
                this.force.y = (this.thrust * Math.sin(this.facing * Math.PI / 180));
                this.velocity.x += this.force.x / this.mass;
                this.velocity.y += this.force.y / this.mass;
                if (Math.abs(this.velocity.x > 10))
                    this.velocity.x = 10
                this.pos.x += this.velocity.x;
                if (Math.abs(this.velocity.y > 10))
                    this.velocity.y = 10
                this.pos.y += this.velocity.y;
            }
            this.shoot = function () {
                this.shotCharges--;
                this.reloading = true;
                p = new Projectile(this.pos.x, this.pos.y, this.facing, this.shotCount++);
                playerBodies.push(p);
                setTimeout(function () {
                    playerShip.reloading = false
                }, 250);
                setTimeout(function () {
                    playerShip.shotCharges++;
                }, 2000);
                p.startTimer();
            }
        }

        function Projectile(xloc, yloc, heading, shotCount) {
            this.pos = {
                x: xloc,
                y: yloc
            };
            this.id = shotCount;
            this.velocity = 6;
            this.acceleration = 0;
            this.facing = heading;
            this.radius = 5;
            this.draw = function () {
                ctx.save();
                ctx.strokeStyle = "white";
                ctx.translate(this.pos.x, this.pos.y);
                ctx.rotate(this.facing * Math.PI / 180);
                ctx.beginPath();
                ctx.moveTo(10, 0);
                ctx.lineTo(7, -2);
                ctx.lineTo(0, -2);
                ctx.lineTo(0, 2);
                ctx.lineTo(7, 2);
                ctx.lineTo(10, 0);
                ctx.lineTo(10, 0);
                ctx.stroke();
                ctx.closePath();
                ctx.restore();
            }
            this.move = function () {
                this.pos.x += (this.velocity * Math.cos(this.facing * Math.PI / 180));
                this.pos.y += (this.velocity * Math.sin(this.facing * Math.PI / 180));
            }
            this.startTimer = function () {
                var projectile = this;
                setTimeout(function () {
                    projectile.despawnProjectile()
                }, 1000);
            }
            this.despawnProjectile = function () {
                //console.log(this.id);

                for (var i in playerBodies)
                    if (playerBodies[i].id === this.id) {
                        playerBodies.splice(i, 1);
                    }

            }

        }

        function Roid() { //creates an asteroid

            this.pos = {
                x: Math.random() * 800,
                y: Math.random() * 600
            };
            this.velocity = Math.random() * 2;
            this.facing = Math.random() * 360;
            this.direction = Math.random() * 360;
            this.radius = 10;
            this.spin = Math.random() * 5;
            this.draw;
            this.move = function () {
                this.facing += this.spin;
                this.pos.x += (this.velocity * Math.cos(this.direction * Math.PI / 180));
                this.pos.y += (this.velocity * Math.sin(this.direction * Math.PI / 180));
            }
        }

        function drawSmallRoid() {
            ctx.save();
            ctx.strokeStyle = "white";
            ctx.translate(this.pos.x, this.pos.y);
            ctx.rotate(this.facing * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(10, 0);
            ctx.lineTo(5, 8);
            ctx.lineTo(0, 8);
            ctx.lineTo(-8, 8);
            ctx.lineTo(-9, 0);
            ctx.lineTo(-4, -6);
            ctx.lineTo(-8, -9);
            ctx.lineTo(-5, -11);
            ctx.lineTo(3, -10);
            ctx.lineTo(8, -1);
            ctx.lineTo(10, 0);
            ctx.stroke();
            ctx.closePath();
            ctx.restore();
        };

        function drawMediumRoid() {
            ctx.save();
            ctx.strokeStyle = "white";
            ctx.translate(this.pos.x, this.pos.y);
            ctx.rotate(this.facing * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(20, 0);
            ctx.lineTo(15, 10);
            ctx.lineTo(10, 17);
            ctx.lineTo(5, 19);
            ctx.lineTo(0, 20);
            ctx.lineTo(-2, 19);
            ctx.lineTo(-4, 18);
            ctx.lineTo(-8, 16);
            ctx.lineTo(-8, 16);
            ctx.lineTo(-17, 8);
            ctx.lineTo(-18, 4);
            ctx.lineTo(-18, 4);
            ctx.lineTo(-19, 0);
            ctx.lineTo(-15, -10);
            ctx.lineTo(-12, -10);
            ctx.lineTo(-8, -7);
            ctx.lineTo(0, -18);
            ctx.lineTo(15, -20);
            ctx.lineTo(18, -15);
            ctx.lineTo(20, 0);
            ctx.stroke();
            ctx.closePath();
            ctx.restore();
        };

        function drawLargeRoid() {
            ctx.save();
            ctx.strokeStyle = "white";
            ctx.translate(this.pos.x, this.pos.y);
            ctx.rotate(this.facing * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(30, 0);
            ctx.lineTo(25, 10);
            ctx.lineTo(20, 20);
            ctx.lineTo(10, 25);
            ctx.lineTo(0, 30);
            ctx.lineTo(-2, 19);
            ctx.lineTo(-8, 16);
            ctx.lineTo(-8, 16);
            ctx.lineTo(-17, 8);
            ctx.lineTo(-20, 4);
            ctx.lineTo(-26, 4);
            ctx.lineTo(-30, 0);
            ctx.lineTo(-15, -15);
            ctx.lineTo(-12, -25);
            ctx.lineTo(0, -18);
            ctx.lineTo(15, -30);
            ctx.lineTo(18, -15);
            ctx.lineTo(30, 0);
            ctx.stroke();
            ctx.closePath();
            ctx.restore();
        };
        $(document).on("keydown", function () {
            if (event.which == 87) { //w
                presses[0] = true;
            }
            if (event.which == 65) { //a
                presses[1] = true;
            }
            if (event.which == 83) { //s
                presses[2] = true;
            }
            if (event.which == 68) { //d
                presses[3] = true;
            }
            if (event.which == 32) { //space
                presses[4] = true;
            }

        });
        $(document).on("keyup", function () {
            if (event.which == 87) { //w
                presses[0] = false;
            }
            if (event.which == 65) { //a
                presses[1] = false;
            }
            if (event.which == 83) { //s
                presses[2] = false;
            }
            if (event.which == 68) { //d
                presses[3] = false;
            }
            if (event.which == 32)
                presses[4] = false;

        });

        function checkPresses() {
            if (presses[0] == true) {

                playerShip.thrust = 2;

            } else
                playerShip.thrust = 0;
            if (presses[1] == true) {
                playerShip.facing -= 5;
            }
            if (presses[2] == true) {
                playerShip.thrust = -2;
            }
            if (presses[3] == true) {
                playerShip.facing += 5;
            }
            if (presses[4] == true && playerShip.reloading == false && playerShip.shotCharges > 0)
                playerShip.shoot();
        }

        function colCheck() {
            var i = j = 0;
            for (i = 0; i < playerBodies.length; i++) {
                boundaryCheck(playerBodies[i]);
                for (j = 0; j < asteroids.length; j++) {
                    boundaryCheck(asteroids[j]);

                    try { //on the offchance a projectile despawned at the perfect time, this needs exception handling.
                        var distX = playerBodies[i].pos.x - asteroids[j].pos.x;
                        var distY = playerBodies[i].pos.y - asteroids[j].pos.y;
                        var dist = (distX * distX) + (distY * distY);
                        var radSqrd = (playerBodies[i].radius + asteroids[j].radius) * (playerBodies[i].radius + asteroids[j].radius);
                        var bool = Boolean(dist < radSqrd);
                        if (bool) {
                            //console.log("col: ");
                            //console.log(bodies[i]);
                            //console.log(bodies[j]);
                            if (i == 0) {
                                window.alert("Game Over!");
                                location.reload();
                                return;
                            } else {
                                roidCount--;
                                playerShip.score += 100;
                                playerBodies.splice(i, 1);
                                if (asteroids[j].radius == 28)
                                    splodeLargeRoid(asteroids[j].pos.x, asteroids[j].pos.y);
                                else if(asteroids[j].radius == 18)
                                    splodeMediumRoid(asteroids[j].pos.x, asteroids[j].pos.y);
                                asteroids.splice(j, 1);

                                if (i >= playerBodies.length)
                                    return;
                            }
                        } //collision
                    } catch (err) {
                        console.log(err.message);
                    }
                }

            }
        }

        function boundaryCheck(body) {

            if (body.pos.x + body.radius < 0) //make sure the object leaves the LEFT SIDE before moving it
            {
                body.pos.x = canvas.width + body.radius;
            }
            if (body.pos.x - body.radius > canvas.width) //make sure the object leaves the RIGHT SIDE before moving it
            {
                body.pos.x = 0 + body.radius;
            }
            if (body.pos.y + body.radius < 0) //make sure the object leaves the TOP before moving it
            {
                body.pos.y = canvas.height - body.radius;
            }
            if (body.pos.y - body.radius > canvas.height) //make sure the object leaves the TOP before moving it
            {
                body.pos.y = 0 + body.radius;
            }
        }

        function splodeLargeRoid(x, y) {
            console.log(x +" " +y);
            for (var i = 0; i < 2; i++) {
                newRoid = new Roid();
                newRoid.pos.x = x;
                newRoid.pos.y = y;
                newRoid.radius = 18;
                newRoid.draw = drawMediumRoid;
                asteroids.push(newRoid);
                roidCount++;
            }
        }

        function splodeMediumRoid(x,y) {
            for (var i = 0; i < 2; i++) {
                newRoid = new Roid();
                newRoid.pos.x = x;
                newRoid.pos.y = y;
                newRoid.radius = 8;
                newRoid.draw = drawSmallRoid;
                asteroids.push(newRoid);
                roidCount++;
            }
        }

        function step() {
            ctx.save();
            ctx.fillStyle = "black";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            checkPresses();
            for (var i in playerBodies) {
                playerBodies[i].move();
                playerBodies[i].draw();
            }
            for (var i in asteroids) {
                asteroids[i].move();
                asteroids[i].draw();
            }
            ctx.fillStyle = "white";
            //ctx.fillText(playerShip.facing, 0, 0);
            colCheck();
            if (roidCount == 0) {
                window.alert("You Win!");
                location.reload();
            }
            ctx.fillText("Score: " + playerShip.score, 10, 10);
            ctx.restore();
            window.requestAnimationFrame(step);
        }
    </script>
</body>

</html>